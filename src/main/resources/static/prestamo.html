<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestamos</title>
    <link rel="stylesheet" href="prestamo-diseño.css">

</head>
<body>
    <h1>Gestión de Préstamos</h1>

    <form id="registroPrestamo">
        <div>
            <label for="montoPrestamo">Monto del Préstamo:</label>
            <input type="number" id="montoPrestamo" required>
        </div>

        <div>
            <label for="interesPrestamo">Interés:</label>
            <input type="number" id="interesPrestamo" required>
        </div>

        <div>
            <label for="plazoPrestamo">Plazo (cantidad de pagos):</label>
            <input type="number" id="plazoPrestamo" required>
        </div>

                <div>
            <label for="fechaRegistro">fecha</label>
            <input type="date" id="fechaRegistro">
        </div>

        <button type="submit" id="btnRegistrarPrestamo">Registrar Préstamo</button>
    </form>


    <h2>Clientes y sus Préstamos</h2>
    <ul id="listaClientes"></ul>

    <div id="modalRenovar" style="display:none;" class="modal">
        <div class="modal-content">
            <h3>Renovar Préstamo</h3>

            <label>Monto solicitado</label>
            <input type="number" id="nuevoMonto">

            <label>Interés</label>
            <input type="number" id="nuevoInteres">

            <label>Plazo</label>
            <input type="number" id="nuevoPlazo">

            <button id="confirmarRenovacion">Renovar</button>
            <button onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>

    <script>
    let prestamoActual = null;

    // Obtener clienteId desde la URL para cargar sus préstamos
    const params = new URLSearchParams(window.location.search);
    const clienteId = params.get("clienteId");

    if (!clienteId) {
        alert("Cliente no encontrado");
    }

    // cargar cliente con sus prestamos
    function cargarClienteConPrestamos() {
    fetch(`/clientes/${clienteId}`)
        .then(res => res.json())
        .then(cliente => {
            const lista = document.getElementById("listaClientes");
            lista.innerHTML = "";

            const liCliente = document.createElement("li");
            liCliente.innerHTML = `<strong>${cliente.nombre}</strong>`;

            const ulPrestamos = document.createElement("ul");

            const prestamosActivos = cliente.prestamos ? cliente.prestamos.filter(prestamo => !prestamo.estado): [];

            if (prestamosActivos.length > 0) {
                prestamosActivos.forEach(prestamo => {

                    const liPrestamo = document.createElement("li");

                    liPrestamo.textContent =
                        `Monto: ${prestamo.monto}, Total a Pagar: ${prestamo.totalAPagar}, Interés: ${prestamo.interes}, Plazo: ${prestamo.plazo},  Fecha de Registro: ${formatoFecha(prestamo.fechaRegistro)}`;

                    agregarFormularioPago(prestamo, liPrestamo);
                    mostrarPagos(prestamo, liPrestamo);

                    ulPrestamos.appendChild(liPrestamo);
                });
            } else {
                ulPrestamos.innerHTML = "<li>Sin préstamos</li>";
            }
            liCliente.appendChild(ulPrestamos);
            lista.appendChild(liCliente);
        })
        .catch(err => console.error("Error cargando cliente:", err));
}

    // formulario para agregar pago a un prestamo
    function agregarFormularioPago(prestamo, liPrestamo) {
        const inputPago = document.createElement("input");
        inputPago.type = "number";
        inputPago.placeholder = "Monto del pago";

        const botonPago = document.createElement("button");
        botonPago.textContent = "Registrar pago";

        liPrestamo.appendChild(document.createElement("br"));
        liPrestamo.appendChild(inputPago);
        liPrestamo.appendChild(botonPago);

        botonPago.onclick = function () {
            const montoPago = parseFloat(inputPago.value);

            if (isNaN(montoPago) || montoPago <= 0) {
                alert("Ingrese un monto válido");
                return;
            }

            if (montoPago > prestamo.totalAPagar) {
                alert("El monto del pago no puede exceder el total a pagar del préstamo");
                return;
            }

            const pagoData = {
                monto: montoPago
            };

            fetch(`/pagos/prestamo/${prestamo.id}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(pagoData)
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Error al guardar el pago");
                }
                return res.json();
            })
            .then(() => {
                alert("✅ Pago registrado");
                cargarClienteConPrestamos();
            })
            .catch(err => {
                console.error(err);
                alert("❌ Error al registrar el pago");
            });
        };
    }

    // se muestran los pagos realizados para un prestamo
    function mostrarPagos(prestamo, liPrestamo) {

    let tituloPagos = document.createElement("h4");
    tituloPagos.textContent = "Pagos Realizados:";
    liPrestamo.appendChild(tituloPagos);

    let montoEsperado = prestamo.totalAPagar / prestamo.plazo;
    let infoEsperado = document.createElement("p");
    infoEsperado.textContent = `Monto esperado por pago: ${montoEsperado.toFixed(2)}`;
    liPrestamo.appendChild(infoEsperado);

    fetch(`/pagos/prestamo/${prestamo.id}`)
        .then(res => res.json())
        .then(pagos => {

            const ulPagos = document.createElement("ol");
            ulPagos.classList.add("lista-pagos");

            let totalPagado = 0;
            let saldoRestante = prestamo.totalAPagar;

            let btnElimiarPago = document.createElement("button");
            btnElimiarPago.textContent = "ELiminar";
            btnElimiarPago.classList.add("eliminar-pago");

            if (pagos.length > 0) {
                pagos.forEach(pago => {
                    totalPagado += pago.monto;
                    saldoRestante = prestamo.saldoRestante || (prestamo.totalAPagar - totalPagado);

                    const liPago = document.createElement("li");
                    liPago.textContent =
                        `Monto del Pago: ${pago.monto}, Fecha: ${formatoFecha(new Date())}`;
                    ulPagos.appendChild(liPago);

                    // boton para eliminar pago
                    const botonEliminarPago = btnElimiarPago.cloneNode(true);
                    liPago.appendChild(botonEliminarPago);

                    botonEliminarPago.onclick = function () {
                        if (confirm("¿Está seguro de eliminar este pago? Esta acción no se puede deshacer.")) {
                            fetch(`/pagos/${pago.id}`, {
                                method: "DELETE"
                            })
                            .then(res => {
                                if (!res.ok) {
                                    throw new Error("Error al eliminar el pago");
                                }
                                alert("✅ Pago eliminado correctamente");
                                cargarClienteConPrestamos();
                            })
                            .catch(err => {
                                console.error(err);
                                alert("❌ Error al eliminar el pago");
                            });
                        }
                    }
                });
            } else {
                ulPagos.innerHTML = "<li>Sin pagos registrados</li>";
            }

            liPrestamo.appendChild(ulPagos);

            // agregar interes por retraso al prestamo
            let interesPorRetraso = document.createElement("input");
            interesPorRetraso.type = "number";
            interesPorRetraso.placeholder = "Interés por retraso";
            liPrestamo.appendChild(interesPorRetraso);

            let botonInteres = document.createElement("button");
            botonInteres.textContent = "Agregar interés por prestamo";
            liPrestamo.appendChild(botonInteres);

            botonInteres.onclick = function () {
                const interesRetraso = parseFloat(interesPorRetraso.value);

                if (isNaN(interesRetraso) || interesRetraso <= 0) {
                    alert("Ingrese un interés válido");
                    return;
                }

                fetch(`/prestamos/${prestamo.id}/interes`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        monto: interesRetraso
                    })
                })
                .then(res => {
                    if (!res.ok) {
                        throw new Error("Error al actualizar el préstamo");
                    }
                    return res.json();
                })
                .then(() => {
                    alert("✅ Interés por retraso agregado");
                    cargarClienteConPrestamos();
                })
                .catch(err => {
                    console.error(err);
                    alert("❌ Error al agregar el interés por retraso");
                });
            };

            // mostrar total pagado y saldo restante
            
            const saldoInfo = document.createElement("p");
            saldoInfo.textContent = `Total Pagado: ${totalPagado} | Saldo Restante: ${saldoRestante}`;

            liPrestamo.appendChild(saldoInfo);


            // boton para cerrar prestamo si el saldo es 0
            let botoncerrarPrestamo = document.createElement("button");
            botoncerrarPrestamo.textContent = "Cerrar Préstamo";
            botoncerrarPrestamo.classList.add("cerrar");
            liPrestamo.appendChild(botoncerrarPrestamo);

            botoncerrarPrestamo.onclick = function () {
                if (confirm("¿Está seguro de cerrar este préstamo? Esta acción no se puede deshacer.")) {
                    fetch(`/prestamos/${prestamo.id}/cerrar`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error("Error al cerrar el préstamo");
                        }
                        return res.json();
                    })
                    .then(() => {
                        alert("✅ Préstamo cerrado correctamente");
                        cargarClienteConPrestamos();
                    })
                    .catch(err => {
                        console.error(err);
                        alert("❌ Error al cerrar el préstamo");
                    });
                }
            };


            // Crear boton para eliminar prestamo
            let botonEliminarPrestamo = document.createElement("button");
            botonEliminarPrestamo.textContent = "Eliminar Préstamo";
            botonEliminarPrestamo.classList.add("eliminar");
            liPrestamo.appendChild(botonEliminarPrestamo);

            botonEliminarPrestamo.onclick = function () {
                if (confirm("¿Está seguro de eliminar este préstamo? Esta acción no se puede deshacer.")) {
                    fetch(`/prestamos/${prestamo.id}/`, {
                        method: "DELETE"
                    })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error("Error al eliminar el préstamo");
                        }
                        alert("✅ Préstamo eliminado correctamente");
                        cargarClienteConPrestamos();
                    })
                    .catch(err => {
                        console.error(err);
                        alert("❌ Error al eliminar el préstamo");
                    });
                }
            };

            // Renovar prestamo, se trae un modal para ingresar nuevos datos y se llama al endpoint
            let botonRenovarPrestamo = document.createElement("button");
            botonRenovarPrestamo.textContent = "Renovar Préstamo";
            botonRenovarPrestamo.classList.add("renovar");
            liPrestamo.appendChild(botonRenovarPrestamo);

            botonRenovarPrestamo.onclick = function () {
                prestamoActual = prestamo.id;
                document.getElementById("modalRenovar").style.display = "flex";
            };

            document.getElementById("confirmarRenovacion").onclick = function () {

                if (!prestamoActual) {
                    alert("No hay préstamo seleccionado");
                    return;
                }

                const nuevoMonto = parseFloat(document.getElementById("nuevoMonto").value);
                const nuevoInteres = parseFloat(document.getElementById("nuevoInteres").value);
                const nuevoPlazo = parseInt(document.getElementById("nuevoPlazo").value);

                if (isNaN(nuevoMonto) || nuevoMonto <= 0 || isNaN(nuevoInteres) || nuevoInteres <= 0 || isNaN(nuevoPlazo) || nuevoPlazo <= 0) {
                    alert("Datos inválidos para la renovación");
                    return;
                }

                fetch(`/prestamos/${prestamoActual}/renovar`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        monto: nuevoMonto,
                        interes: nuevoInteres,
                        plazo: nuevoPlazo
                    })
                })
                .then(res => {
                    if (!res.ok) throw new Error();
                    return res.json();
                })
                .then(() => {
                    alert("✅ Préstamo renovado correctamente");
                    cerrarModal();
                    cargarClienteConPrestamos();
                })
                .catch(() => alert("❌ Error al renovar el préstamo"));
            };
        })
        .catch(err => console.error("Error cargando pagos:", err));
    }


    function cerrarModal() {
        document.getElementById("modalRenovar").style.display = "none";
        document.getElementById("nuevoMonto").value = "";
        document.getElementById("nuevoInteres").value = "";
        document.getElementById("nuevoPlazo").value = "";
        prestamoActual = null;
    }


    // formato de fecha DD/MM/AAAA
    function formatoFecha(fecha) {
    if (fecha instanceof Date) {
        const dia = String(fecha.getDate()).padStart(2, '0');
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        const año = fecha.getFullYear();
        return `${dia}/${mes}/${año}`;
    }

    if (typeof fecha === "string" && fecha.includes("-")) {
        const [año, mes, dia] = fecha.split("-");
        return `${dia}/${mes}/${año}`;
    }

    return "Fecha no disponible";
    }



    //Ejecutar al cargar la página
    cargarClienteConPrestamos();

    //Registrar préstamo PARA ESTE CLIENTE
    document.getElementById("registroPrestamo").addEventListener("submit", function (e) {
        e.preventDefault();

        let montoPrestamo = document.getElementById("montoPrestamo").value.trim();
        let interesPrestamo = document.getElementById("interesPrestamo").value.trim();
        let plazoPrestamo = document.getElementById("plazoPrestamo").value.trim();
        let fechaRegistro = document.getElementById("fechaRegistro").value.trim();
        fechaRegistro = fechaRegistro ? fechaRegistro : new Date().toISOString().split('T')[0];
        let totalAPagar = parseFloat(montoPrestamo) + (parseFloat(interesPrestamo) * (parseFloat(montoPrestamo) / parseFloat(1000)));

        let prestamoData = {
            monto: parseFloat(montoPrestamo),
            interes: parseFloat(interesPrestamo),
            plazo: parseInt(plazoPrestamo),
            fechaRegistro: fechaRegistro,
            estado: false,
            totalAPagar: totalAPagar,
            saldoRestante: totalAPagar

        };

        fetch(`/prestamos/cliente/${clienteId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(prestamoData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Error al guardar el préstamo");
            }
            return response.json();
        })
        .then(data => {
            alert("✅ Préstamo registrado correctamente");
            cargarClienteConPrestamos();
            document.getElementById("registroPrestamo").reset();
        })
        .catch(error => {
            console.error("Error:", error);
            alert("❌ Error al registrar el préstamo");
        });
    });
</script>
</body>

</html>